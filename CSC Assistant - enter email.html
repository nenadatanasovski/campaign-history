<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>amaysim</title>
    <!-- Bootstrap CSS -->
    <link rel="Shortcut Icon" type="image/png" href="https://image.e.amaysim.com.au/lib/fe941573726c077875/m/1/86950ce6-b199-45ad-8f86-2842bb1af383.png" />
    <link rel="stylesheet" type="text/css" href="https://pages.e.amaysim.com.au/page.aspx?QS=38dfbe491fab00ea784457a8361003cd35ebb34eb7278d6159fd91108d03a48a" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link href="jquery-ui.min.css" rel="stylesheet">
    <link href="jquery.comiseo.daterangepicker.css" rel="stylesheet">
    <script src="jquery.min.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="moment.min.js"></script>
    <script src="jquery.comiseo.daterangepicker.js"></script>
    <script>
        $(function() { $("#e1").daterangepicker(); });
    </script>
<style> input { width: 575px; height: 45px; } h3 { padding-top: 20px; padding-bottom: 7px; margin: 0px; } </style>
  </head>
  <script type="text/javascript">
    var url = 'https://api.ipify.org';
    var request = new XMLHttpRequest();
    request.onreadystatechange = function() {
        if (request.readyState === 4) {
            if (request.status === 200) {
                document.body.className = 'ok';
                document.cookie = 'ipAddress=' + request.responseText;
            } else { document.body.className = 'error';}}};
    request.open("GET", url , true);
    request.send(null);
</script>
<script runat=server>
    Platform.Load("Core","1");
    var ip = Platform.Request.GetCookieValue('ipAddress');
  Variable.SetValue("@ip",ip);
</script>
%%[
/* Get Safety params */
SET @secretHash = QueryParameter('h')
SET @secret = '4509%%4609?^%%^jklddsajk4?$^43234kjl?DFDSDF'
SET @date = FormatDate(SystemdateToLocalDate(NOW()), "YYYY-MM-DD")
SET @GUID = 
IIF(IsNull(LookupOrderedRows('CSC_Verification_System',0,'SystemDate Desc','LoginDate',@date)),Redirect(Concat('http://pub.e.amaysim.com.au/csc-verification','?hashcheck=',@HashCheck,'&secretHash=',@secretHash)),Field(Row(LookupOrderedRows('CSC_Verification_System',0,'SystemDate Desc','LoginDate',@date),1),'VerificationCode'))
SET @HashCheck = SHA256(concat(@secret, @GUID, @date),"UTF-16")
IIF(@HashCheck != @secretHash,
  Redirect(Concat('http://pub.e.amaysim.com.au/csc-verification','?hashcheck=',@HashCheck,'&secretHash=',@secretHash)),'')
]%%
<body class="page-home"><br>
<div class="container">
  <h1>CSC Assistant - Service & campaign info</h1>
  <br><br>
  <form action="" method="post">
  <h3>Search campaign history by customer email address</h3> 
      <div class="input-text-submittable">
        <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
          <div class="form-group">
            <input type="hidden" value="submitted" name="submitted" >
            <input type="text" class="form-control" id="email" name="email" placeholder="Enter customer's email address">
          </div>
        </div>
      </div>
      <div class="col-xs-12 col-sm-16 col-md-6 col-lg-6">
        <br>
        <button type="submit" class="btn btn-default">Submit</button>
      </div>
</form><br><br>
%%[
SET @submit = requestparameter("submitted")
IF @submit == 'submitted' AND @ipcheck == 'Access granted' THEN
SET @ipcheck = IIF(IsNull(RowCount(LookupRows('IP_Addresses_amaysim','IP_Address',@ip))),RaiseError('Unregistered IP address'),'Access granted')
SET @D1 = requestParameter('D1')
SET @D2 = requestParameter('D2')
SET @CustomerEmail = Trim(requestParameter('email'))
SET @EmailSubscriptionStatus = IIF(IsNull(LookupRows('ent._Subscribers','EmailAddress', @CustomerEmail)),'not found in system',Lookup('ent._Subscribers','Status','EmailAddress', @CustomerEmail))
SET @Sent = LookupOrderedRows('GEAL_DV',0,'DateSent Desc','EmailAddress', @CustomerEmail)
IIF(RowCount(@Sent) < 1, Redirect('http://pub.e.amaysim.com.au/csc-email-not-found'),'')
SET @LogoEmailSub = IIF(@EmailSubscriptionStatus == 'active','https://image.e.amaysim.com.au/lib/fe9415747365027b76/m/1/c053a43a-634a-4362-97a4-30c8120c834e.png','https://image.e.amaysim.com.au/lib/fe9415747365027b76/m/1/8a977db3-7b99-4759-92ea-378b614cfb8f.png')
]%%
<h2>Email address: %%=v(@CustomerEmail)=%%</h2>
<h3 style="color:%%=IIF(@EmailSubscriptionStatus == 'active','green','red')=%%;"><img src=%%=v(@LogoEmailSub)=%% height="20" width="20"> Subscribed to email marketing | Status: %%=v(@EmailSubscriptionStatus)=%%</h3>
<br><br>
%%[ IF @EmailSubscriptionStatus != 'not found in system' THEN
SET @SubscriberID = Lookup('GEAL_DV','SubscriberID','EmailAddress',@CustomerEmail)
SET @SubscriberKey = Lookup('ent._Subscribers','SubscriberKey', 'SubscriberID',@SubscriberID)
SET @mobileRowSet = LookupOrderedRows('mobile_services',0,'sfmc_date_added DESC','subscriber_key',@SubscriberKey)
SET @mobileService = IIF(IsNull(@mobileRowSet),'0','1')
SET @mobileSRowCount = RowCount(@mobileRowSet)
SET @energyRowSet = LookupOrderedRows('energy_services',0,'date_created DESC','subscriber_key',@SubscriberKey)
SET @energyService = IIF(IsNull(@energyRowSet),'0','1')
SET @energySRowCount = RowCount(@energyRowSet)
SET @mobileLogo = 'https://www.amaysim.com.au/sites/default/files/contact-icons/help_icons_sim_plans.svg'
SET @energyLogo = 'https://www.amaysim.com.au/sites/default/files/2017-10/help_icons_energy_1.svg'
SET @emailLogo = 'https://dop.mosreg.ru/img/mail_or.png'
IF @mobileService == '1' THEN ]%%
<h3>&nbsp;Mobile service(s) <img src=%%=v(@mobileLogo)=%% height="30" width="30"></h3>
  <table class="table table-striped" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <th class="text-center">Mobile&nbsp;Number</th>
        <th class="text-center">Mobile&nbsp;Service&nbsp;Plan</th>
        <th class="text-center">Auto-topup</th>
        <th class="text-center">Data&nbsp;Pack</th>
        <th class="text-center">Extra&nbsp;Data</th>
        <th class="text-center">Status&nbsp;Service</th>
        <th class="text-center">(EC)&nbsp;SMS&nbsp;marketing&nbsp;opt-in</th>
      </tr>
  <tr></tr>
  %%[ FOR @u = 1 to @mobileSRowCount DO
   SET @Mrow = Row(@mobileRowSet, @u)
   SET @serviceID = Field(@Mrow,'service_id')
   SET @MMobileNumber = Lookup('mobile_services','mobile_number','service_id',@serviceID)
   SET @MService = Lookup('mobile_services','plan1_retail_name','service_id',@serviceID)
   SET @MAutoTopup = Lookup('mobile_services','auto_top_up','service_id',@serviceID)
   SET @MDataPack = Lookup('mobile_services','plan2_retail_name','service_id',@serviceID)
   SET @MStatusService = IIF(Lookup('mobile_services','phone_status_current_code','service_id',@serviceID) == '0','Active','Inactive')
   SET @MSMSMKT = Lookup('mobile_services','marketing_opt_in','service_id',@serviceID)
  ]%%
      <td class="text-center">%%=v(@MMobileNumber)=%%</td>
      <td class="text-center">%%=v(@MService)=%%</td>
      <td class="text-center">%%=v(@MAutoTopup)=%%</td>
      <td class="text-center">%%=v(@DateSent)=%%</td>
      <td class="text-center">%%=v(@MDataPack)=%%</td>
      <td class="text-center">%%=v(@MStatusService)=%%</td>
      <td class="text-center">%%=v(@MSMSMKT)=%%</td>
      </tr>
  %%[ NEXT @u ]%%%%[ ENDIF ]%%
  </table>
%%[ IF @energyService == '1' THEN ]%%<br>
<h3>&nbsp;Energy service(s) <img src=%%=v(@energyLogo)=%% height="30" width="30"></h3>
  <table class="table table-striped" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <th class="text-center">Energy&nbsp;Plan</th>
        <th class="text-center">Purchased&nbsp;Date</th>
        <th class="text-center">Connected&nbsp;Date</th>
        <th class="text-center">Disconnected&nbsp;Date</th>
        <th class="text-center">PostCode</th>
        <th class="text-center">Status&nbsp;Service</th>
        <th class="text-center">Source&nbsp;Purchased</th>
      </tr>
   <tr></tr>
  %%[ FOR @e = 1 to @energySRowCount DO
   SET @Erow = Row(@energyRowSet, @e)
   SET @serviceID = Field(@Erow,'service_id')
   SET @plan_name = Lookup('energy_services','plan_name','service_id',@serviceID)
   SET @fuel_purchased_date = Lookup('energy_services','fuel_purchased_date','service_id',@serviceID)
   SET @fuel_connected_date = Lookup('energy_services','fuel_connected_date','service_id',@serviceID)
   SET @fuel_disconnected_date = Lookup('energy_services','fuel_disconnected_date','service_id',@serviceID)
   SET @energy_postcode = Lookup('energy_services','energy_postcode','service_id',@serviceID)
   SET @energy_status = Lookup('energy_services','energy_status','service_id',@serviceID)
   SET @source = Lookup('energy_services','source','service_id',@serviceID)
  ]%%
      <td class="text-center">%%=v(@plan_name)=%%</td>
      <td class="text-center">%%=v(@fuel_purchased_date)=%%</td>
      <td class="text-center">%%=v(@fuel_connected_date)=%%</td>
      <td class="text-center">%%=v(@fuel_disconnected_date)=%%</td>
      <td class="text-center">%%=v(@energy_postcode)=%%</td>
      <td class="text-center">%%=v(@energy_status)=%%</td>
      <td class="text-center">%%=v(@source)=%%</td>
      </tr>
  %%[ NEXT @e ]%%
  </table><br>
%%[ ENDIF ]%%%%[ ENDIF ]%%%%[ IF RowCount(@Sent) > 0 THEN ]%%
<table class="table table-striped" border="0" cellspacing="0" cellpadding="0">
<h3>&nbsp;Email sends&nbsp;&nbsp<img src=%%=v(@emailLogo)=%% height="30" width="30"></h3>
    <tr>
      <th class="text-center">Email&nbsp;Name</th>
      <th class="text-center">Subject</th>
      <th class="text-center">Preheader</th>
      <th class="text-center">Date&nbsp;Sent</th>
      <th class="text-center">Bounced</th>
      <th class="text-center">Opened</th>
      <th class="text-center">View</th>
    </tr>
 <tr></tr>
%%[ FOR @i = 1 to Rowcount(@Sent) DO
 SET @row = Row(@Sent, @i)
 SET @EventID = Field(@row,'EventID')
 SET @SubjectLine = Lookup('GEAL_DV','SubjectLine','EventID',@EventID)
 SET @Preheader = Lookup('GEAL_DV','Preheader','EventID',@EventID)
 SET @DateSent = Lookup('GEAL_DV','DateSent','EventID',@EventID)
 SET @EmailName = Lookup('GEAL_DV','EmailName','EventID',@EventID)
 SET @Bounced = Lookup('GEAL_DV','Bounced','EventID',@EventID)
 SET @DateOpened = IIF(EMPTY(Lookup('GEAL_DV','DateOpened','EventID',@EventID)),'NO','YES')
 SET @ViewOnlineURL = Concat('http://pub.e.amaysim.com.au/htmlpreview/?qp=',@EventID)
]%%
    <td class="text-center">%%=v(@EmailName)=%%</td>
    <td class="text-center">%%=v(@SubjectLine)=%%</td>
    <td class="text-center">%%=v(@Preheader)=%%</td>
    <td class="text-center">%%=v(@DateSent)=%%</td>
    <td class="text-center">%%=v(@Bounced)=%%</td>
    <td class="text-center">%%=v(@DateOpened)=%%</td>
    <td class="text-center"><a href="%%=v(@ViewOnlineURL)=%%">Open</a></td>
</tr>
%%[ NEXT @i ]%%%%[ ENDIF ]%%
</table>
%%[ ENDIF ]%%
</div>
</body>
</html>
